name: Update Active Repos

on:
  schedule:
    - cron: "0 */12 * * *"  # runs every 12 hours
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch Active Repos and Update README
        run: |
          echo "Fetching repos..."

          # Get top 3 most recently updated repos
          repos=$(curl -s "https://api.github.com/users/Coderfaal/repos?per_page=100" \
            | jq -r '.[] | {name: .name, updated_at: .updated_at, html_url: .html_url} | @base64' \
            | sort -t '"' -k6,6r | head -n 3)

          output=""

          counter=1
          for repo in $repos; do
            _jq() { echo ${repo} | base64 --decode | jq -r ${1}; }
            name=$(_jq '.name')
            url=$(_jq '.html_url')
            updated=$(_jq '.updated_at')
            output+="${counter}. [${name}](${url}) â€” updated on ${updated}\n"
            counter=$((counter+1))
          done

          # Replace inside README
          sed -i "/<!-- ACTIVE_REPOS_START -->/,/<!-- ACTIVE_REPOS_END -->/c\
<!-- ACTIVE_REPOS_START -->\
${output}\
<!-- ACTIVE_REPOS_END -->" README.md

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          add: "README.md"
          message: "Updated active repositories section"
